<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>后台管理系统</title>
		<link href="css/bootstrap.min.css" rel="stylesheet" />
		<style>
			body {
				background: #EEEEEE;
			}
			
			#userList {
				text-align: center;
				max-height: 670px;
				min-height: 670px;
				overflow-y: auto;
				background: #FFFFFF;
				border-right: 1px solid #E5E5E5;
			}
			
			#userData {
				text-align: center;
				background: #FFFFFF;
				border-bottom: 1px solid #E5E5E5;
			}
			
			#quanxianList {
				text-align: center;
				background: #FFFFFF;
				height: 466px;
			}
			
			.user-list {
				list-style: none;
				font-size: 16px;
				padding: 0 0;
				text-align: center;
			}
			
			.user-list>li {
				display: block;
				padding: 10px 0px;
				cursor: pointer;
				border-bottom: 1px solid #DCDCDC;
			}
			
			#quanxianList {
				font-size: 16px;
			}
			
			.quanxian-list {
				list-style: none;
				font-size: 16px;
				padding: 0 0;
				overflow: auto;
				text-align: left;
				border-left: 1px solid #E5E5E5;
				margin-bottom: 0px;
			}
			
			.quanxian-list>li {
				display: block;
				padding: 10px 0px;
				cursor: pointer;
				border-top: 1px solid #E5E5E5;
			}
			
			.background {
				background: #30A4FF;
				color: #FFFFFF;
			}
			span{
				cursor: pointer;
			}
		</style>
	</head>

	<body>

		<div class="container">

			<div id="userList" class="col-md-2">
				<h3>用户一览表</h3>
				<ul class="user-list">
										
				</ul>
			</div>

			<div id="userData" class="col-md-10 col-md-offset-0">
				<h3>修改</h3>
				<form class="form-horizontal form-label-left">
					<div class="form-group">
						<label class="control-label col-md-2">用户名：</label>
						<div class="col-md-6">
							<input type="text" id="username" class="form-control" placeholder="用户名" />
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">密码：</label>
						<div class="col-md-6">
							<input type="text" id="password" class="form-control" placeholder="密码" />
						</div>
					</div>
					<div class="form-group">
						<div class="col-md-6 col-md-offset-1">
							<button type="button" id="delete" class="btn btn-danger">删除</button>
							<button type="button" id="save" class="btn btn-primary">保存</button>
							<button type="reset" class="btn btn-success">复位</button>
							<button id="close" class="btn btn-default">关闭</button>
						</div>
					</div>
				</form>
			</div>

			<div id="quanxianList" class="col-md-10">
				<h3>基本权限分配表</h3>
				<div class="col-md-5" style="max-height: 400px;min-height: 100px;overflow-y: auto;border: 1px solid #E5E5E5;padding: 0px 0px;margin-bottom: 10px;">
					<div>
						<span class="col-md-4" style="float: left;padding: 10px 0;">功能模块</span>
						<span class="col-md-8" style="float: right;border-left: 1px solid #E5E5E5;padding: 10px 0;">未分配基本权限</span>
					</div>
					<div id="weifenpei">
						
					</div>
				</div>

				<div class="col-md-2">
					<div style="margin: 60px auto">
						<button id="toRight" class="btn btn-default">>></button>
					</div>
					<div>
						<button id="toLeft" class="btn btn-default"><<</button>
					</div>
				</div>

				<div class="col-md-5" style="max-height: 400px;min-height: 100px;overflow-y: auto;border: 1px solid #E5E5E5;padding: 0px 0px;margin-bottom: 10px;">
					<div>
						<span class="col-md-4" style="float: left;padding: 10px 0;">功能模块</span>
						<span class="col-md-8" style="float: right;border-left: 1px solid #E5E5E5;padding: 10px 0;">已分配基本权限</span>
					</div>
					<div id="yifenpei">
						
					</div>
				</div>
			</div>

		</div>

		<script src="js/jquery-1.12.4.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script>
			
			$('.user-list').on('click', 'li', function() {
				if($(this).text() != '用户名') {
					$('.user-list>li').each(function() {
						if($(this).hasClass('background')) $(this).removeClass("background");
					}) 
					$(this).addClass("background");	
					$.post('./script/interface.jsp', {
						'username': $(this).text(),
						'request': 'getPassword'
					}, function(data) {
						var data = JSON.parse(data);
						if(data.status == true) {
							document.getElementById('username').value = data.username;
							document.getElementById('password').value = data.password;
						}
					});
					getRightList($(this).text());
				}
			});
			
			function clearList(){
				$('#weifenpei>div>.quanxian-list').html('');
				$('#weifenpei>div>.quanxian-list').append('<li>无</li>');				
				$('#yifenpei>div>.quanxian-list').html('');
				$('#yifenpei>div>.quanxian-list').append('<li>无</li>');
			}
			
			
			
			$('#toRight').click(function(){
				var myStr = {data:Array()};
				var username = '';
				var i = 0;
				$('.user-list>li').each(function(){
					if($(this).text() != '用户名'){
						if($(this).hasClass('background')){
							username = $(this).text();
						}
					}
				});
				if(username == ''){
					return;
				}
				$('#weifenpei .quanxian-list>li').each(function(){
					if($(this).hasClass('background')){
						myStr.data[i] = $(this).text();
						i++;
					}
				});
				if(i == 0){
					return;
				}
				$.post('./script/interface.jsp',
					{
						'username' : username,
						'data' : JSON.stringify(myStr),
						'request' : 'fenpeiquanxian'
					},
					function(data){
						data = JSON.parse(data);
						if(data.status == true){
							getRightList(username);
						}
					}
				);
			});
			
			$('#toLeft').click(function(){
				var myStr = {data:Array()};
				var username = '';
				var i = 0;
				$('.user-list>li').each(function(){
					if($(this).text() != '用户名'){
						if($(this).hasClass('background')){
							username = $(this).text();
						}
					}
				});
				if(username == ''){
					return;
				}
				$('#yifenpei .quanxian-list>li').each(function(){
					if($(this).hasClass('background')){
						myStr.data[i] = $(this).text();
						i++;
					}
				});
				if(i == 0){
					return;
				}
				$.post('./script/interface.jsp',
					{
						'username' : username,
						'data' : JSON.stringify(myStr),
						'request' : 'huishouquanxian'
					},
					function(data){
						data = JSON.parse(data);
						if(data.status == true){
							getRightList(username);
						}
					}
				);
			});
			
			$('#close').click(function() {
				window.close();
			});
			
			$('#delete').click(function() {
					if(document.getElementById('username').value != '') {
						$.post('./script/interface.jsp', {
							'username': document.getElementById('username').value,
							'request': 'deleteUserInfo'
						}, function(data) {
							var data = JSON.parse(data);
							if(data.status == true) {
								alert('删除成功！');
								$('.user-list').html('');								
								getUserList();
							} else {
								alert('这是一个不存在的用户名！');
							}
						})
					} else {
						alert('用户名与密码不能为空！');
					}
				}
			);
			
			$('#save').click(function() {
					if(document.getElementById('username').value != '' && document.getElementById('password').value != '') {
						$.post('./script/interface.jsp', {
							'username': document.getElementById('username').value,
							'password': document.getElementById('password').value,
							'request': 'changeUserInfo'
						}, function(data) {
							//alert(data);
							var data = JSON.parse(data);
							if(data.status == 2) {
								alert('注册成功！');
								$('.user-list').html('');								
								getUserList();
							} else if(data.status == 1){
								alert('修改密码成功！');
							}else{
								alert('注册失败，用户名已存在！');
							}
						})
					} else {
						alert('用户名与密码不能为空！');
					}
				}

			);

			function getUserList() {
				$.post('./script/interface.jsp', {
					'request': 'getUserList'
				}, function(data) {
					//alert(data);
					var data = JSON.parse(data);
					if(data.status == true) {
						$('.user-list').append('<li>用户名</li>');
						var i = 0;
						try {
							while(data.data[i].username) {
								$('.user-list').append('<li id="shit">' + data.data[i].username + '</li>');
								i++;
							}
						} catch(e) {}
					}
				})
			}
			
			function getRightList(username){
				$.post('./script/interface.jsp', {
						'username': username,
						'request': 'getUserRights'
					}, function(data) {
						//alert(data);
						var data = JSON.parse(data);
						if(data.status == true) {
							var i = 0;
							clearList();						
							try{
								while(data.weifenpei[i].rightName){
									if($('#weifenpei>.'+data.weifenpei[i].Module+'>.quanxian-list>li:first').text() == '无')
										$('#weifenpei>.'+data.weifenpei[i].Module+'>.quanxian-list').html('');
									$('#weifenpei>.'+data.weifenpei[i].Module+'>.quanxian-list').append('<li>'+data.weifenpei[i].rightName+'</li>');									
									i++;
								}
							}catch(e){
							
							}
							i = 0;
							try{
								while(data.yifenpei[i].rightName){
									//alert(data.weifenpei[i].Module);		
									if($('#yifenpei>.'+data.yifenpei[i].Module+'>.quanxian-list>li:first').text() == '无')
										$('#yifenpei>.'+data.yifenpei[i].Module+'>.quanxian-list').html('');
									$('#yifenpei>.'+data.yifenpei[i].Module+'>.quanxian-list').append('<li>'+data.yifenpei[i].rightName+'</li>');
									i++;
								}
							}catch(e){
								
							}
						}
//						if(lyn == 0){
//							listLi();
//						}
					});
				
			}
			
			function getBaseClear(){
				$.post('./script/interface.jsp',
					{
						'request' : 'getBaseClear'
					},
					function(data){
						//alert(data);
						data = JSON.parse(data);						
						var i = 0;
						try{
							while(data.data[i].Module){
								var str = `
								<div class=`+data.data[i].Module+`>
									<span class="col-md-4" style="float: left;padding: 10px 0px;border-top: 1px solid #E5E5E5;">`+data.data[i].Module+`</span>
									<ul class="quanxian-list col-md-8">								
										<li>无</li>
									</ul>
								</div>`;
								$('#yifenpei').append(str);
								$('#weifenpei').append(str);
								i++;
							}
						}catch(e){
							
						}
						listLi();
					}
				);
			}
			
			function listLi(){
				$('.quanxian-list').on('click','li',function(){
					if($(this).text() != '无'){
						if($(this).hasClass('background')){
							$(this).removeClass('background');
						}else{
							$(this).addClass('background');
						}
					}
				});
				$('#yifenpei').on('click','span',function(){
					if($(this).siblings('ul').children('li').text() != '无'){
						var j = 0;
						$(this).siblings('ul').children('li').each(function(){
							if(!$(this).hasClass('background')){
								$(this).siblings('li').each(function(){
									$(this).addClass('background');
								});
								$(this).addClass('background');
								j = 1;
								return;
							}
						});
						if(j == 0){
							$(this).siblings('ul').children('li').each(function(){
								$(this).removeClass('background');
							});
						}
					}
				});
				$('#weifenpei').on('click','span',function(){
					if($(this).siblings('ul').children('li').text() != '无'){
						var j = 0;
						$(this).siblings('ul').children('li').each(function(){
							if(!$(this).hasClass('background')){
								$(this).siblings('li').each(function(){
									$(this).addClass('background');
								});
								$(this).addClass('background');
								j = 1;
								return;
							}
						});
						if(j == 0){
							$(this).siblings('ul').children('li').each(function(){
								$(this).removeClass('background');
							});
						}
					}
				});
			}
			$(document).ready(function() {
				getUserList();	
				getBaseClear();		
			});
		</script>
	</body>

</html>